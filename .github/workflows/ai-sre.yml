name: AI DevSecOps Pipeline

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy-and-audit:
    runs-on: self-hosted

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: 1. Deploy Vulnerable App
        # PowerShell is the default on Windows runners, so we use its syntax.
        run: |
          Write-Host "üöÄ Deploying application to Kubernetes..."
          
          # Check if deployment exists to avoid errors
          $dep = kubectl get deployment ci-cd-vulnerable --ignore-not-found
          
          if (-not $dep) {
             # Create it if it doesn't exist
             kubectl create deployment ci-cd-vulnerable --image=alpine:3.10
          } else {
             # Reset it to the vulnerable image if it does exist
             kubectl set image deployment/ci-cd-vulnerable *=alpine:3.10
          }
          
          Write-Host "‚è≥ Waiting for deployment to stabilize..."
          Start-Sleep -Seconds 10

      - name: 2. Setup Python
        run: |
          python -m pip install --upgrade pip
          if (Test-Path requirements.txt) { pip install -r requirements.txt }

      - name: 3. Run AI SRE Agent
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          # Explicitly tell Python to use UTF-8 for console output to avoid encoding errors
          PYTHONIOENCODING: "utf-8"
        run: |
          Write-Host "ü§ñ Starting AI Audit..."
          python sre_agent_final.py
      
      - name: 4. Verify Fixes
        run: |
          Write-Host "‚úÖ Verifying cluster state..."
          kubectl get pods -l app=ci-cd-vulnerable