name: AI DevSecOps Pipeline

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: # Allows manual trigger from UI

jobs:
  deploy-and-audit:
    # RUN ON YOUR LAPTOP (See Setup Guide below)
    runs-on: self-hosted

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: 1. Deploy Application (Simulated)
        run: |
          echo "üöÄ Deploying application to Kubernetes..."
          # In a real scenario, this would apply your k8s manifests
          # For this demo, we ensure a vulnerable app exists to test the AI
          kubectl create deployment ci-cd-vulnerable --image=alpine:3.10 --dry-run=client -o yaml | kubectl apply -f - || true
          kubectl set image deployment/ci-cd-vulnerable *=alpine:3.10
          echo "‚è≥ Waiting for deployment to stabilize..."
          sleep 10

      - name: 2. Setup Python
        # Self-hosted runners usually have python, but we ensure env setup
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: 3. Run AI SRE Agent
        env:
          # We inherit the key from the runner's environment or GitHub Secrets
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          echo "ü§ñ Starting AI Audit..."
          python sre_agent_final.py
      
      - name: 4. Verify Fixes
        run: |
          echo "‚úÖ Verifying cluster state..."
          kubectl get pods -l app=ci-cd-vulnerable