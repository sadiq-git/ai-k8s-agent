name: AI DevSecOps Pipeline

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy-and-audit:
    runs-on: self-hosted

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: 1. Deploy Vulnerable App (With Sleep)
        run: |
          Write-Host "üöÄ Deploying application to Kubernetes..."
          
          $dep = kubectl get deployment ci-cd-vulnerable --ignore-not-found
          
          if (-not $dep) {
             # Fix: Add '-- sleep 3600' so the container stays running and doesn't crash
             kubectl create deployment ci-cd-vulnerable --image=alpine:3.10 -- sleep 3600
          } else {
             # Reset to vulnerable image for the demo
             kubectl set image deployment/ci-cd-vulnerable *=alpine:3.10
          }
          
          Write-Host "‚è≥ Waiting for deployment to stabilize..."
          Start-Sleep -Seconds 10

      - name: 2. Setup Python
        run: |
          python -m pip install --upgrade pip
          if (Test-Path requirements.txt) { pip install -r requirements.txt }

      - name: 3. Run AI SRE Agent
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          PYTHONIOENCODING: "utf-8"
        run: |
          Write-Host "ü§ñ Starting AI Audit..."
          python sre_agent_final.py
      
      - name: 4. Verify Fixes
        run: |
          Write-Host "‚úÖ Verifying cluster state..."
          # Wait a moment for the new pod to start
          Start-Sleep -Seconds 5
          kubectl get pods -l app=ci-cd-vulnerable