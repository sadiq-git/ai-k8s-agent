name: AI DevSecOps Pipeline

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy-and-audit:
    runs-on: self-hosted

    # üî¥ CRITICAL FIX: Force usage of Git Bash (Windows version)
    # This prevents it from trying to use WSL/Ubuntu
    defaults:
      run:
        shell: "C:\\Program Files\\Git\\bin\\bash.exe" --noprofile --norc -e -o pipefail {0}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: 1. Deploy Application (Simulated)
        run: |
          echo "üöÄ Deploying application to Kubernetes..."
          # Now '|| true' will work because we are in Git Bash
          kubectl create deployment ci-cd-vulnerable --image=alpine:3.10 --dry-run=client -o yaml | kubectl apply -f - || true
          
          # Force the update to the vulnerable image
          kubectl set image deployment/ci-cd-vulnerable *=alpine:3.10
          
          echo "‚è≥ Waiting for deployment to stabilize..."
          sleep 10

      - name: 2. Setup Python
        run: |
          # We use the Windows python
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: 3. Run AI SRE Agent
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          echo "ü§ñ Starting AI Audit..."
          python sre_agent_final.py
      
      - name: 4. Verify Fixes
        run: |
          echo "‚úÖ Verifying cluster state..."
          kubectl get pods -l app=ci-cd-vulnerable